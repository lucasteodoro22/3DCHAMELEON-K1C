# 3DChameleon Klipper Configuration
# Adaptado para controlar via PC817C optocoupler
# Estilo compatível com sistemas TURBO

# --- Pinagem ---
[output_pin troca_cor]
pin: PA0
pwm: False
value: 0
shutdown_value: 0

# --- Variáveis 3DChameleon ---
[gcode_macro VARIAVEIS_CHAMELEON]
# TEMPO E CONTROLE
variable_pulso: 400              # tempo do pulso (ms) = 400ms por pulso (do código original Arduino)
variable_aguardar: 3000          # espera entre comandos do Arduino (ms)
variable_extrusaodatroca: 30     # mm de filamento empurrado na troca
variable_tempo_unload: 3000     # tempo maximo para unload (3s)
variable_tempo_load: 3000       # tempo maximo para load (3s)

# TEMPERATURA
variable_temperaturabico: 230    # temperatura do bico em trocas

gcode:
  M117 "VARIAVEIS_CHAMELEON carregado"

# --- Controle Geral ---
[gcode_macro _OFF_]
description: Desliga o botão
gcode:
  SET_PIN PIN=troca_cor VALUE=0

[gcode_macro _ON_]
description: Liga o botão
gcode:
  SET_PIN PIN=troca_cor VALUE=1

# --- Lógica Principal (Baseada no Sistema Original) ---

# O sistema original conta PULSOS baseado no TEMPO que o botão fica pressionado
# Cada 400ms = 1 pulso (delay no código original)
# Então precisamos simular o tempo de pressão, não enviar pulsos separados

[gcode_macro PULSAR]
description: Simula pressionamento do botão por tempo suficiente para N pulsos
variable_alvo: -1
gcode:
  {% set pulso = printer["gcode_macro VARIAVEIS_CHAMELEON"].pulso|int %}  # Tempo por pulso
  {% set novo_alvo = params.N|int %}
  {% if novo_alvo < 1 or novo_alvo > 10 %} # Validação (1..10 para Chameleon)
    RESPOND TYPE=error MSG="Pulso {novo_alvo} inválido. Escolha um número entre 1 e 10"
  {% else %}
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE={novo_alvo}
    {% set tempo_total = novo_alvo * pulso %}  # Tempo total de pressão
    _ON_
    G4 P{tempo_total}
    _OFF_
    M117 "Comando {novo_alvo} enviado ({tempo_total}ms)"
  {% endif %}

[gcode_macro ESCOLHER]
description: Troca de filamento seguindo a lógica do código original Arduino
variable_novo_alvo: 0
gcode:
  {% set aguardar = printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int %}
  {% set novo_alvo = params.N|int %}
  {% set atual = printer["gcode_macro PULSAR"].alvo|int %}

  {% set desc_list = ["","T0 Selected","T1 Selected","T2 Selected","T3 Selected","Home/Load T0","Unload/Home","Home","Next Tool","Random Tool","Extra"] %}

  # --- HOME inicial se necessário ---
  {% if atual == -1 and novo_alvo not in [7,8] %}
    M117 "Homing inicial necessário..."
    PULSAR N=7  # Home
    G4 P{aguardar}
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
  {% endif %}

  {% if novo_alvo < 1 or novo_alvo > 10 %}
    M117 "ERRO: Comando {novo_alvo} inválido!"
    M117 "2: T0, 3: T1, 4: T2, 5: T3, 6: Home/Load T0, 7: Unload/Home, 8: Home, 9: Next, 10: Random"
  {% else %}
    {% set desc_novo = desc_list[novo_alvo] if (1 <= novo_alvo <= 9) else "??" %}
    M117 "Executando: {desc_novo}"

    # Envia o comando baseado no número de pulsos
    PULSAR N={novo_alvo}
    G4 P{aguardar}

    # Atualiza estado baseado no comando
    {% if novo_alvo == 7 %}  # Home
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
    {% elif novo_alvo == 6 %}  # Unload/Home
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
    {% elif novo_alvo == 5 %}  # Home/Load T0
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=1
    {% elif 1 <= novo_alvo <= 4 %}  # Troca para T0-T3
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE={novo_alvo}
    {% endif %}

    M117 "Comando executado - aguardando resposta do Chameleon"
  {% endif %}

# --- Sistema Interativo (3 Etapas) ---

[gcode_macro T0_SELECIONAR]
description: Etapa 1 - Seleciona T0 (pressionamento longo)
gcode:
  M117 "ETAPA 1: Selecionando T0..."
  PULSAR N=2  # Seleciona T0
  G4 P1000
  M117 "Sistema foi para posicao antiga. Execute T0_UNLOAD quando pronto"

[gcode_macro T0_UNLOAD]
description: Etapa 2 - Unload da extrusora atual (segurar ate soltar)
gcode:
  M117 "ETAPA 2: Fazendo UNLOAD - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  M117 "Unload concluido. Pressione T0_LOAD quando pronto"

[gcode_macro T0_LOAD]
description: Etapa 3 - Load da T0 (segurar ate soltar)
gcode:
  M117 "ETAPA 3: Fazendo LOAD T0 - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=1
  M117 "T0 carregada com sucesso!"

[gcode_macro T1_SELECIONAR]
description: Etapa 1 - Seleciona T1
gcode:
  M117 "ETAPA 1: Selecionando T1..."
  PULSAR N=3  # Seleciona T1
  G4 P1000
  M117 "Sistema foi para posicao antiga. Execute T1_UNLOAD quando pronto"

[gcode_macro T1_UNLOAD]
description: Etapa 2 - Unload para T1
gcode:
  M117 "ETAPA 2: Fazendo UNLOAD - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  M117 "Unload concluido. Pressione T1_LOAD quando pronto"

[gcode_macro T1_LOAD]
description: Etapa 3 - Load da T1
gcode:
  M117 "ETAPA 3: Fazendo LOAD T1 - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=2
  M117 "T1 carregada com sucesso!"

[gcode_macro T2_SELECIONAR]
description: Etapa 1 - Seleciona T2
gcode:
  M117 "ETAPA 1: Selecionando T2..."
  PULSAR N=4  # Seleciona T2
  G4 P1000
  M117 "Sistema foi para posicao antiga. Execute T2_UNLOAD quando pronto"

[gcode_macro T2_UNLOAD]
description: Etapa 2 - Unload para T2
gcode:
  M117 "ETAPA 2: Fazendo UNLOAD - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  M117 "Unload concluido. Pressione T2_LOAD quando pronto"

[gcode_macro T2_LOAD]
description: Etapa 3 - Load da T2
gcode:
  M117 "ETAPA 3: Fazendo LOAD T2 - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=3
  M117 "T2 carregada com sucesso!"

[gcode_macro T3_SELECIONAR]
description: Etapa 1 - Seleciona T3
gcode:
  M117 "ETAPA 1: Selecionando T3..."
  PULSAR N=5  # Seleciona T3
  G4 P1000
  M117 "Sistema foi para posicao antiga. Execute T3_UNLOAD quando pronto"

[gcode_macro T3_UNLOAD]
description: Etapa 2 - Unload para T3
gcode:
  M117 "ETAPA 2: Fazendo UNLOAD - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  M117 "Unload concluido. Pressione T3_LOAD quando pronto"

[gcode_macro T3_LOAD]
description: Etapa 3 - Load da T3
gcode:
  M117 "ETAPA 3: Fazendo LOAD T3 - segure ate soltar..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=4
  M117 "T3 carregada com sucesso!"

# --- Sistema Automático Completo ---
[gcode_macro T0]
description: Troca automática completa para T0
gcode:
  M117 "=== TROCA AUTOMATICA PARA T0 ==="
  M117 "Passo 1: Selecionando T0..."
  PULSAR N=2  # Seleção
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 2: Executando UNLOAD..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 3: Executando LOAD T0..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=1
  M117 "TROCA PARA T0 CONCLUIDA!"

[gcode_macro T1]
description: Troca automática completa para T1
gcode:
  M117 "=== TROCA AUTOMATICA PARA T1 ==="
  M117 "Passo 1: Selecionando T1..."
  PULSAR N=3  # Seleção
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 2: Executando UNLOAD..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 3: Executando LOAD T1..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=2
  M117 "TROCA PARA T1 CONCLUIDA!"

[gcode_macro T2]
description: Troca automática completa para T2
gcode:
  M117 "=== TROCA AUTOMATICA PARA T2 ==="
  M117 "Passo 1: Selecionando T2..."
  PULSAR N=4  # Seleção
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 2: Executando UNLOAD..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 3: Executando LOAD T2..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=3
  M117 "TROCA PARA T2 CONCLUIDA!"

[gcode_macro T3]
description: Troca automática completa para T3
gcode:
  M117 "=== TROCA AUTOMATICA PARA T3 ==="
  M117 "Passo 1: Selecionando T3..."
  PULSAR N=5  # Seleção
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 2: Executando UNLOAD..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
  _OFF_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].aguardar|int}
  M117 "Passo 3: Executando LOAD T3..."
  _ON_
  G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
  _OFF_
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=4
  M117 "TROCA PARA T3 CONCLUIDA!"

[gcode_macro CHAMELEON_LOAD_T0]
description: Home and Load T0 (6 pulsos)
gcode:
  ESCOLHER N=6  # Home/Load T0

[gcode_macro DESCARREGAR_ATUAL]
description: Unload last and Home (7 pulsos)
gcode:
  ESCOLHER N=7  # Unload/Home

[gcode_macro CHAMELEON_HOME]
description: Home apenas (8 pulsos)
gcode:
  ESCOLHER N=8  # Home

[gcode_macro CHAMELEON_NEXT]
description: Next filament (9 pulsos)
gcode:
  ESCOLHER N=9  # Next

[gcode_macro CHAMELEON_RANDOM]
description: Random filament (10 pulsos)
gcode:
  ESCOLHER N=10  # Random

# --- Impressão ---
[gcode_macro INICIO_CHAMELEON]
description: Configuração inicial antes da impressão
gcode:
  SET_PIN PIN=troca_cor VALUE=0
  M117 "3DChameleon: Preparando..."
  CHAMELEON_HOME
  G4 P1000

[gcode_macro FIM_CHAMELEON]
description: Finaliza a impressão e realiza a remoção do filamento
gcode:
  PAUSE
  G92 E0
  DESCARREGAR_ATUAL
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=-1
  M117 "3DChameleon: Filamento removido"

[gcode_macro CANCEL_PRINT]
description: Cancela a impressão e remove o filamento
rename_existing: CANCEL_PRINT_BASE
gcode:
  G0 E-2 F2400
  G92 E0
  DESCARREGAR_ATUAL
  END_PRINT
  CANCEL_PRINT_BASE
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=-1

# --- Informações de Uso ---
# 1. Configure o GPIO correto no [output_pin troca_cor]
# 2. Carregue as variáveis: VARIAVEIS_CHAMELEON
# 3. Use INICIO_CHAMELEON no start G-code
# 4. Use FIM_CHAMELEON no end G-code
# 5. Troque filamento AUTOMATICAMENTE com: T0, T1, T2, T3
# 6. Descarregue com: DESCARREGAR_ATUAL

# --- Sistema Automático Completo ---
#
# O 3DChameleon funciona em 3 ETAPAS INTERATIVAS:
#
# ETAPA 1: SELEÇÃO (pressionamento longo para escolher extrusora)
# - T0_SELECIONAR (2 pulsos = 800ms)
# - T1_SELECIONAR (3 pulsos = 1200ms)
# - T2_SELECIONAR (4 pulsos = 1600ms)
# - T3_SELECIONAR (5 pulsos = 2000ms)
#
# ETAPA 2: UNLOAD (segurar até soltar para descarregar)
# - TX_UNLOAD (pressionamento contínuo até soltar)
#
# ETAPA 3: LOAD (segurar até soltar para carregar)
# - TX_LOAD (pressionamento contínuo até soltar)
#
# EXEMPLO COMPLETO PARA T0:
# 1. T0_SELECIONAR    # Sistema vai para posição antiga
# 2. T0_UNLOAD        # Segurar até soltar (unload)
# 3. T0_LOAD          # Segurar até soltar (load T0)
#
# ATALHOS SIMPLIFICADOS:
# - T0, T1, T2, T3: Fazem seleção + mostram próximos passos
#
# SISTEMA INTERATIVO COMPLETO:
# 1. TX_SELECIONAR    # Sistema vai para posição antiga
# 2. TX_UNLOAD        # Usuário segura até soltar (unload)
# 3. TX_LOAD          # Usuário segura novamente até soltar (load)
#
# OUTROS COMANDOS:
# - CHAMELEON_HOME     # Home (8 pulsos = 3200ms)
# - DESCARREGAR_ATUAL  # Unload/Home (7 pulsos = 2800ms)
# - CHAMELEON_LOAD_T0  # Home/Load T0 (6 pulsos = 2400ms)
#
# DEBUG: PULSAR N=X   # Envia comando diretamente (X=1-10)
