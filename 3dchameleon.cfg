# 3DChameleon Filament Selector (CFS) - Klipper Configuration
# Controla o seletor de filamentos 3DChameleon via pino PA0
# Conecta PA0 ao optoacoplador PC817C que vai para A3 do Arduino Uno

[output_pin cfs_trigger]
pin: PA0
pwm: False
value: 0
shutdown_value: 0

# --- Memória Persistente ---
[save_variables]
filename: ~/chameleon_state.cfg  # Arquivo para salvar estado entre reinicializações

# --- Variáveis 3DChameleon ---
[gcode_macro VARIAVEIS_CHAMELEON]
# TEMPO E CONTROLE
variable_pulso: 400              # tempo do pulso (ms) = 400ms por pulso (do código original Arduino)
variable_aguardar: 3000          # espera entre comandos do Arduino (ms)
variable_distancia_extrusao_load: 87     # mm de filamento empurrado na troca // Tambem e usado como tempo de load do filamento novo
variable_distancia_retracao_unload: 10     # mm de filamento retraido na troca
variable_velocidade_feeding: 500 # velocidade do feeding (mm/min) = 8.33 mm/s
variable_tempo_unload: 12000     # tempo maximo para unload (11s)

# TEMPERATURA
variable_temp_minima_troca: 220  # temperatura mínima para permitir troca

# POSIÇÃO PARA TROCA DE FILAMENTO
variable_x_troca: 150.0          # X para troca de filamento
variable_y_troca: 227.0          # Y para troca de filamento
# variable_z_troca: 50.0         # Z mantida atual (não alterada)

# ESTADO PERSISTENTE

variable_filamento_atual: -1     # -1=desconhecido, 0=T0, 1=T1, 2=T2, 3=T3

gcode:
  M117 "VARIAVEIS_CHAMELEON carregado"

# --- Controle Geral ---
[gcode_macro _OFF_]
description: Desliga o botão
gcode:
  SET_PIN PIN=cfs_trigger VALUE=0

[gcode_macro _ON_]
description: Liga o botão
gcode:
  SET_PIN PIN=cfs_trigger VALUE=1


[gcode_macro CFS_T0]
description: Seleciona filamento T0 (2 pulsos)
gcode:
    # Verifica temperatura do bico antes da troca
    {% set temp_atual = printer.extruder.temperature %}
    {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {% if temp_atual < temp_minima %}
        M117 "Aquecendo bico para troca..."
        {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
        M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
        M117 "Bico aquecido, iniciando troca..."
    {% endif %}

    G0 E-{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_retracao_unload} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz a retração para começar o unload do filamento antigo
    CFS_PULSE COUNT=2 # Envia os pulsos para seleção
    G4 P1000 # Pausa para ele selecionar o filamento antigo
    _ON_ # Ativa o macro de ligar o PA0 para fazer o unload do filamento antigo
    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # aguarda o tempo de unload do filamento antigo
    _OFF_ # Desativa a macro para desligar o PA0 que fez o unload do filamento antigo
    G4 P500 # Pausa para começar a fazer selecionar novo filamento
    _ON_ # Ativa o macro de ligar o PA0 para fazer o load do novo filamento
    G0 E{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao_load} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz o feeding para começar o load do novo filamento
    _OFF_ # Desativa a macro para desligar o PA0 que fez o load do novo filamento

[gcode_macro CFS_T1]
description: Seleciona filamento T1 (3 pulsos)
gcode:
    # Verifica temperatura do bico antes da troca
    {% set temp_atual = printer.extruder.temperature %}
    {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {% if temp_atual < temp_minima %}
        M117 "Aquecendo bico para troca..."
        {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
        M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
        M117 "Bico aquecido, iniciando troca..."
    {% endif %}

    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # arguada o tempo de unload do filamento antigo
    CFS_PULSE COUNT=3 # Envia os pulsos para seleção
    G4 P1000 # Pausa para ele selecionar o filamento antigo
    _ON_ # Ativa o macro de ligar o PA0 para fazer o unload do filamento antigo
    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # aguarda o tempo de unload do filamento antigo
    _OFF_ # Desativa a macro para desligar o PA0 que fez o unload do filamento antigo
    G4 P500 # Pausa para começar a fazer selecionar novo filamento
    _ON_ # Ativa o macro de ligar o PA0 para fazer o load do novo filamento
    G0 E{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao_load} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz o feeding para começar o load do novo filamento
    _OFF_ # Desativa a macro para desligar o PA0 que fez o load do novo filamento

[gcode_macro CFS_T2]
description: Seleciona filamento T2 (4 pulsos)
gcode:
    # Verifica temperatura do bico antes da troca
    {% set temp_atual = printer.extruder.temperature %}
    {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {% if temp_atual < temp_minima %}
        M117 "Aquecendo bico para troca..."
        {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
        M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
        M117 "Bico aquecido, iniciando troca..."
    {% endif %}

    G0 E-{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_retracao_unload} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz a retração para começar o unload do filamento antigo
    CFS_PULSE COUNT=4 # Envia os pulsos para seleção
    G4 P1000 # Pausa para ele selecionar o filamento antigo
    _ON_ # Ativa o macro de ligar o PA0 para fazer o unload do filamento antigo
    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # aguarda o tempo de unload do filamento antigo
    _OFF_ # Desativa a macro para desligar o PA0 que fez o unload do filamento antigo
    G4 P500 # Pausa para começar a fazer selecionar novo filamento
    _ON_ # Ativa o macro de ligar o PA0 para fazer o load do novo filamento
    G0 E{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao_load} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz o feeding para começar o load do novo filamento
    _OFF_ # Desativa a macro para desligar o PA0 que fez o load do novo filamento

[gcode_macro CFS_T3]
description: Seleciona filamento T3 (5 pulsos)
gcode:
    # Verifica temperatura do bico antes da troca
    {% set temp_atual = printer.extruder.temperature %}
    {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {% if temp_atual < temp_minima %}
        M117 "Aquecendo bico para troca..."
        {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
        M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
        M117 "Bico aquecido, iniciando troca..."
    {% endif %}

    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # arguada o tempo de unload do filamento antigo
    CFS_PULSE COUNT=5 # Envia os pulsos para seleção
    G4 P1000 # Pausa para ele selecionar o filamento antigo
    _ON_ # Ativa o macro de ligar o PA0 para fazer o unload do filamento antigo
    G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int} # aguarda o tempo de unload do filamento antigo
    _OFF_ # Desativa a macro para desligar o PA0 que fez o unload do filamento antigo
    G4 P500 # Pausa para começar a fazer selecionar novo filamento
    _ON_ # Ativa o macro de ligar o PA0 para fazer o load do novo filamento
    G0 E{printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao_load} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_feeding|int} # Faz o feeding para começar o load do novo filamento
    _OFF_ # Desativa a macro para desligar o PA0 que fez o load do novo filamento

[gcode_macro CFS_HOME_LOAD]
description: Home e carrega T0 (6 pulsos)
gcode:
    CFS_PULSE COUNT=6

[gcode_macro CFS_UNLOAD_HOME]
description: Descarrega e faz home (7 pulsos)
gcode:
    CFS_PULSE COUNT=7

[gcode_macro CFS_HOME]
description: Apenas home (8 pulsos)
gcode:
    CFS_PULSE COUNT=8

[gcode_macro CFS_NEXT]
description: Próximo filamento (9 pulsos)
gcode:
    CFS_PULSE COUNT=9

[gcode_macro CFS_RANDOM]
description: Filamento aleatório (10 pulsos)
gcode:
    CFS_PULSE COUNT=10

[gcode_macro CFS_PULSE]
description: Envia sinal contínuo LOW para simular pulsos
variable_count: 1
gcode:
    {% set count = params.COUNT|default(1)|int %}

    # Arduino conta "pulsos" enquanto trigger == LOW
    # Cada "pulso" = 400ms de delay no loop
    # Para N pulsos: tempo_total = N * 400ms

    {% set pulse_duration = count * 400 %}  # Tempo em ms
    {% set pulse_seconds = (pulse_duration / 1000.0) %}

    # Debug: mostra informações
    {action_respond_info("CFS: %d pulso(s) = %.1fs LOW" % (count, pulse_seconds))}

    # Sinal LOW contínuo (aciona optoacoplador)
    SET_PIN PIN=cfs_trigger VALUE=1

    # Mantém LOW pelo tempo necessário
    G4 P{pulse_duration}

    # Volta para HIGH (desaciona optoacoplador)
    SET_PIN PIN=cfs_trigger VALUE=0

    # Pequena pausa
    G4 P200

    {action_respond_info("CFS: Comando enviado (%d pulso(s))" % count)}

[gcode_macro CFS_STATUS]
description: Mostra status do CFS
gcode:
    {% set pin_state = printer["output_pin cfs_trigger"].value %}
    {action_respond_info("CFS Trigger Pin PA0: %s" % pin_state)}

[gcode_macro CFS_TEST]
description: Testa conexão CFS (1 pulso)
gcode:
    M117 "Testando CFS..."
    CFS_PULSE COUNT=1
    M117 "CFS OK!"

[gcode_macro CFS_DEBUG_PIN]
description: Testa diretamente o pino PA0
gcode:
    M117 "Testando pino PA0..."
    {action_respond_info("Estado inicial: %s" % printer["output_pin cfs_trigger"].value)}

    SET_PIN PIN=cfs_trigger VALUE=1
    {action_respond_info("Depois de HIGH: %s" % printer["output_pin cfs_trigger"].value)}
    G4 P500

    SET_PIN PIN=cfs_trigger VALUE=0
    {action_respond_info("Depois de LOW: %s" % printer["output_pin cfs_trigger"].value)}

    M117 "Teste do pino concluído"

[gcode_macro CFS_MANUAL_PULSE]
description: Sinal manual contínuo (800ms LOW)
gcode:
    M117 "Sinal manual: 800ms LOW"
    SET_PIN PIN=cfs_trigger VALUE=1
    G4 P800
    SET_PIN PIN=cfs_trigger VALUE=0
    M117 "Sinal concluído"

[gcode_macro CFS_TEST_SLOW]
description: Testa CFS com 1 pulso (400ms)
gcode:
    M117 "Teste: 1 pulso (400ms)"
    CFS_PULSE COUNT=1
    M117 "Teste concluído"

[gcode_macro CFS_TEST_2PULSOS]
description: Testa CFS com 2 pulsos (800ms)
gcode:
    M117 "Teste: 2 pulsos (800ms)"
    CFS_PULSE COUNT=2
    M117 "Teste concluído"

[gcode_macro CFS_STATUS_TEMP]
description: Mostra status de temperatura para trocas
gcode:
    {% set temp_atual = printer.extruder.temperature %}
    {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {% set temp_alvo = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
    {action_respond_info("Temperatura atual: %.1f°C" % temp_atual)}
    {action_respond_info("Temperatura mínima para troca: %.1f°C" % temp_minima)}
    {action_respond_info("Temperatura alvo: %.1f°C" % temp_alvo)}
    {% if temp_atual >= temp_minima %}
        {action_respond_info("✅ Temperatura OK para troca")}
    {% else %}
        {action_respond_info("❌ Temperatura BAIXA - troca bloqueada")}
    {% endif %}

[gcode_macro LOG]
description: Mostra o log no console do Klipper
gcode:
    {action_respond_info("TESTE")}

# Exemplo de uso em macros de mudança de filamento:
# [gcode_macro LOAD_FILAMENT_T0]
# gcode:
#     CFS_T0
#     # Aguardar confirmação do usuário ou sensor
#     M117 "Pressione LOAD no 3DChameleon"
#
# [gcode_macro UNLOAD_FILAMENT]
# gcode:
#     CFS_UNLOAD_HOME
#     M117 "Filamento descarregado"