# 3DChameleon Filament Selector (CFS) - Klipper Configuration
# Controla o seletor de filamentos 3DChameleon via pino PA0
# Conecta PA0 ao optoacoplador PC817C que vai para A3 do Arduino Uno

[output_pin cfs_trigger]
pin: PA0
pwm: False
value: 0
shutdown_value: 0

[gcode_macro CFS_T0]
description: Seleciona filamento T0 (2 pulsos)
gcode:
    CFS_PULSE COUNT=2

[gcode_macro CFS_T1]
description: Seleciona filamento T1 (3 pulsos)
gcode:
    CFS_PULSE COUNT=3

[gcode_macro CFS_T2]
description: Seleciona filamento T2 (4 pulsos)
gcode:
    CFS_PULSE COUNT=4

[gcode_macro CFS_T3]
description: Seleciona filamento T3 (5 pulsos)
gcode:
    CFS_PULSE COUNT=5

[gcode_macro CFS_HOME_LOAD]
description: Home e carrega T0 (6 pulsos)
gcode:
    CFS_PULSE COUNT=6

[gcode_macro CFS_UNLOAD_HOME]
description: Descarrega e faz home (7 pulsos)
gcode:
    CFS_PULSE COUNT=7

[gcode_macro CFS_HOME]
description: Apenas home (8 pulsos)
gcode:
    CFS_PULSE COUNT=8

[gcode_macro CFS_NEXT]
description: Próximo filamento (9 pulsos)
gcode:
    CFS_PULSE COUNT=9

[gcode_macro CFS_RANDOM]
description: Filamento aleatório (10 pulsos)
gcode:
    CFS_PULSE COUNT=10

[gcode_macro CFS_PULSE]
description: Envia sinal contínuo LOW para simular pulsos
variable_count: 1
gcode:
    {% set count = params.COUNT|default(1)|int %}

    # Arduino conta "pulsos" enquanto trigger == LOW
    # Cada "pulso" = 400ms de delay no loop
    # Para N pulsos: tempo_total = N * 400ms

    {% set pulse_duration = count * 400 %}  # Tempo em ms
    {% set pulse_seconds = (pulse_duration / 1000.0) %}

    # Debug: mostra informações
    {action_respond_info("CFS: %d pulso(s) = %.1fs LOW" % (count, pulse_seconds))}

    # Sinal LOW contínuo (aciona optoacoplador)
    SET_PIN PIN=cfs_trigger VALUE=1

    # Mantém LOW pelo tempo necessário
    G4 P{pulse_duration}

    # Volta para HIGH (desaciona optoacoplador)
    SET_PIN PIN=cfs_trigger VALUE=0

    # Pequena pausa
    G4 P200

    {action_respond_info("CFS: Comando enviado (%d pulso(s))" % count)}

[gcode_macro CFS_STATUS]
description: Mostra status do CFS
gcode:
    {% set pin_state = printer["output_pin cfs_trigger"].value %}
    {action_respond_info("CFS Trigger Pin PA0: %s" % pin_state)}

[gcode_macro CFS_TEST]
description: Testa conexão CFS (1 pulso)
gcode:
    M117 "Testando CFS..."
    CFS_PULSE COUNT=1
    M117 "CFS OK!"

[gcode_macro CFS_DEBUG_PIN]
description: Testa diretamente o pino PA0
gcode:
    M117 "Testando pino PA0..."
    {action_respond_info("Estado inicial: %s" % printer["output_pin cfs_trigger"].value)}

    SET_PIN PIN=cfs_trigger VALUE=1
    {action_respond_info("Depois de HIGH: %s" % printer["output_pin cfs_trigger"].value)}
    G4 P500

    SET_PIN PIN=cfs_trigger VALUE=0
    {action_respond_info("Depois de LOW: %s" % printer["output_pin cfs_trigger"].value)}

    M117 "Teste do pino concluído"

[gcode_macro CFS_MANUAL_PULSE]
description: Sinal manual contínuo (800ms LOW)
gcode:
    M117 "Sinal manual: 800ms LOW"
    SET_PIN PIN=cfs_trigger VALUE=1
    G4 P800
    SET_PIN PIN=cfs_trigger VALUE=0
    M117 "Sinal concluído"

[gcode_macro CFS_TEST_SLOW]
description: Testa CFS com 1 pulso (400ms)
gcode:
    M117 "Teste: 1 pulso (400ms)"
    CFS_PULSE COUNT=1
    M117 "Teste concluído"

[gcode_macro CFS_CLEAR_EEPROM]
description: Limpa EEPROM do Arduino (11 pulsos)
gcode:
    M117 "Limpando EEPROM..."
    CFS_PULSE COUNT=11
    M117 "EEPROM limpa"

[gcode_macro CFS_TEST_2PULSOS]
description: Testa CFS com 2 pulsos (800ms)
gcode:
    M117 "Teste: 2 pulsos (800ms)"
    CFS_PULSE COUNT=2
    M117 "Teste concluído"

# Exemplo de uso em macros de mudança de filamento:
# [gcode_macro LOAD_FILAMENT_T0]
# gcode:
#     CFS_T0
#     # Aguardar confirmação do usuário ou sensor
#     M117 "Pressione LOAD no 3DChameleon"
#
# [gcode_macro UNLOAD_FILAMENT]
# gcode:
#     CFS_UNLOAD_HOME
#     M117 "Filamento descarregado"