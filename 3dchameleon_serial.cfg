# 3DChameleon Filament Selector (CFS) - Serial Interface Configuration ✅
# Controla o seletor de filamentos 3DChameleon via interface serial
#
# STATUS: Sistema AUTOMÁTICO com shell_command
# - Módulo shell_command: INSTALADO ✅
# - Script: /usr/data/printer_data/config/control_arduino.py ✅
# - Macros: Funcionam automaticamente ✅

# --- Sistema Serial 3DChameleon ---
# Configuração baseada na documentação: https://github.com/dw-0/kiauh/blob/master/docs/gcode_shell_command.md

[gcode_shell_command arduino_control]
command: sh -c "python3 /usr/data/printer_data/config/control_arduino.py \"$@\"" --
timeout: 30.0
verbose: True

[gcode_shell_command chameleon_state]
command: sh -c "python3 /usr/data/printer_data/config/chameleon_state.py \"$@\"" --
timeout: 10.0
verbose: True

[save_variables]
filename: /usr/data/printer_data/config/current_filament.cfg


# --- Variáveis 3DChameleon Serial ---
[gcode_macro VARIAVEIS_CHAMELEON]
# CONTROLE SERIAL
variable_aguardar: 2000          # espera entre comandos do Arduino (ms)
variable_distancia_load: 10     # mm de filamento para LOAD
variable_distancia_unload: 830    # mm de filamento para UNLOAD
variable_tempo_load: 8000         # tempo de load do filamento (ms)
variable_tempo_unload: 8000       # tempo de unload do filamento (ms)
variable_velocidade_retracao: 900 # velocidade de retracao (mm/min) = 15 mm/s
variable_velocidade_extrusao: 500 # velocidade de extrusao (mm/min) = 8.33 mm/s
variable_distancia_retracao: 50    # mm de filamento para RETRACAO
variable_distancia_extrusao: 50    # mm de filamento para EXTRUSAO

# TEMPERATURA
variable_temp_minima_troca: 220  # temperatura mínima para permitir troca

# POSIÇÃO PARA TROCA DE FILAMENTO
variable_x_troca: 150.0          # X para troca de filamento
variable_y_troca: 227.0          # Y para troca de filamento

# POSIÇÕES PARA CORTE DE FILAMENTO (sequência segura)
variable_x_corte_1: 50.0         # X primeira posição corte (Y200 X50)
variable_y_corte_1: 200.0        # Y primeira posição corte
variable_x_corte_2: 50.0         # X segunda posição corte (Y226 X50)
variable_y_corte_2: 226.0        # Y segunda posição corte
variable_x_corte_3: 6           # X terceira posição corte (Y226 X6)
variable_y_corte_3: 226.0        # Y terceira posição corte
variable_x_corte_4: 50.0         # X segunda posição corte (Y226 X50)
variable_y_corte_4: 226.0        # Y segunda posição corte
variable_x_corte_5: 6           # X terceira posição corte (Y226 X6)
variable_y_corte_6: 226.0        # Y terceira posição corte
variable_x_corte_7: 50.0         # X segunda posição corte (Y226 X50)
variable_y_corte_7: 226.0        # Y segunda posição corte
variable_x_corte_8: 6           # X terceira posição corte (Y226 X6)
variable_y_corte_8: 226.0        # Y terceira posição corte
variable_x_corte_final: 50.0     # X posição final corte (Y226 X50)
variable_y_corte_final: 226.0    # Y posição final corte

# POSIÇÕES PARA PURGA DE FILAMENTO
variable_x_purga: 229.0           # X posição de purga
variable_y_purga: 206.0          # Y posição de purga
variable_z_min_purga: 36.0       # Z mínimo para purga (se Z atual < 36, vai para 36)
variable_distancia_purga: 50.0   # mm de filamento para purga
variable_velocidade_purga: 300   # velocidade de purga (mm/min)

# ESTADO PERSISTENTE
variable_filamento_atual: -1     # -1=desconhecido, 0=T0, 1=T1, 2=T2, 3=T3

gcode:
    M117 "VARIAVEIS_CHAMELEON carregado"


[gcode_macro LOAD_CURRENT_FILAMENT]
gcode:
    {% set valor = printer.save_variables.variables.filamento %}
    {action_respond_info("Filamento atual: T%d" % valor)}
    SET_GCODE_VARIABLE MACRO=VARIAVEIS_CHAMELEON VARIABLE=filamento_atual VALUE={valor}


[gcode_macro CURRENT_FILAMENT]
gcode:
    # Acessa o valor atual que está na memória da macro VARIAVEIS_CHAMELEON
    {% set f = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}
    
    # Exibe o resultado baseado no valor encontrado
    {% if f == -1 %}
        {action_respond_info("Chameleon: Filamento atual é DESCONHECIDO (-1)")}
    {% else %}
        {action_respond_info("Chameleon: O filamento na memória é o T%d" % f)}
    {% endif %}

[gcode_macro SET_CURRENT_FILAMENT]
description: Atualiza o filamento atual no arquivo e na memória. Ex: ATUALIZAR_FILAMENTO T=0
gcode:
    {% if params.T is defined %}
        {% set novo_t = params.T | int %}
        
        # 1. Salva no arquivo físico (para persistir após reiniciar)
        SAVE_VARIABLE VARIABLE=filamento VALUE={novo_t}
        
        # 2. Atualiza a variável global na memória (para uso imediato)
        SET_GCODE_VARIABLE MACRO=VARIAVEIS_CHAMELEON VARIABLE=filamento_atual VALUE={novo_t}
        
        {action_respond_info("Chameleon: Estado atualizado para T%d (Arquivo e RAM)" % novo_t)}
    {% else %}
        {action_respond_info("Erro: Use ATUALIZAR_FILAMENTO T=0 (ou 1, 2, 3)")}
    {% endif %}




[gcode_macro CFS_SEND_COMMAND]
gcode:
  {% set cmd = params.COMMAND %}
  RUN_SHELL_COMMAND CMD=arduino_control PARAMS="{cmd}"


[gcode_macro T0]
description: Seleciona filamento T0
gcode:
    # Verificar PRIMEIRO se já está na ferramenta desejada (antes de qualquer ação)
    {% set filamento_atual = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}

    # Salvar posição atual do bico para retornar depois (sempre, pois pode ser útil)
    {% set pos_x_atual = printer.toolhead.position.x %}
    {% set pos_y_atual = printer.toolhead.position.y %}
    {% set pos_z_atual = printer.toolhead.position.z %}
    {% if filamento_atual == 0 %}
        M118 "T0 já selecionado"
    {% else %}
        M118 Filamento antigo: T{filamento_atual}, Novo: T0
        # Verificar e carregar estado se necessário
        {% set filamento_antigo = filamento_atual %}
        {% if filamento_antigo == -1 %}
            # Tentar carregar estado salvo se não foi inicializado
            M118 Estado não inicializado - carregando...
            LOAD_CURRENT_FILAMENT
            G4 P1000  # Aguardar carregamento
            {% set filamento_antigo = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}
        {% endif %}

        # Verifica temperatura do bico antes da troca
        {% set temp_atual = printer.extruder.temperature %}
        {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
        {% if temp_atual < temp_minima %}
            M118 Aquecendo bico para troca...
            {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
            M109 S{temp_minima|int}
            M118 Bico aquecido, iniciando troca...
        {% endif %}

        # CORTAR FILAMENTO ATUAL (só quando precisa trocar)
        M118 Cortando filamento atual...
        CFS_CUT
        M118 Corte concluído

        # PURGAR FILAMENTO RESIDUAL (só quando precisa trocar)
        M118 Executando purga residual...
        CFS_PURGE
        M118 Purga concluída


        # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500

        # Retração do filamento atual
        {% set distancia_retracao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_retracao %}
        G0 E-{distancia_retracao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_retracao|int}
        G4 P500

         # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        {% set distancia_unload = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_unload %}
        CFS_SEND_COMMAND COMMAND="UNLOAD {distancia_unload|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
        G4 P500
        # LOAD: Ir para posição do FILAMENTO NOVO (T0) e carregar
        CFS_SEND_COMMAND COMMAND="T0"
        G4 P1000
        {% set distancia_load = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_load %}
        CFS_SEND_COMMAND COMMAND="LOAD {distancia_load|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}

        # Posicionamento final
        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500
        {% set distancia_extrusao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao %}
        G0 E{distancia_extrusao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_extrusao|int}

        # RETORNAR PARA POSIÇÃO SALVA ANTES DA TROCA
        {action_respond_info("Retornando para posição anterior: X%.1f Y%.1f Z%.1f" % (pos_x_atual, pos_y_atual, pos_z_atual))}
        G0 X{pos_x_atual} Y{pos_y_atual} Z{pos_z_atual} F6000

        # Atualizar estado persistente
        SET_CURRENT_FILAMENT T=0
        M118 "Filamento T0 carregado - posição restaurada"
    {% endif %}


[gcode_macro T1]
description: Seleciona filamento T1
gcode:
    # Verificar PRIMEIRO se já está na ferramenta desejada (antes de qualquer ação)
    {% set filamento_atual = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}

    # Salvar posição atual do bico para retornar depois (sempre, pois pode ser útil)
    {% set pos_x_atual = printer.toolhead.position.x %}
    {% set pos_y_atual = printer.toolhead.position.y %}
    {% set pos_z_atual = printer.toolhead.position.z %}
    {% if filamento_atual == 1 %}
        M118 Já está selecionado o filamento T1
        # Atualizar estado mesmo assim (por segurança)
        SET_CURRENT_FILAMENT T=1
    {% else %}
        M118 Filamento antigo: T{filamento_atual}, Novo: T1
        # Verificar e carregar estado se necessário
        {% set filamento_antigo = filamento_atual %}
        {% if filamento_antigo == -1 %}
            # Tentar carregar estado salvo se não foi inicializado
            M118 Estado não inicializado - carregando...
            LOAD_CURRENT_FILAMENT
            G4 P1000  # Aguardar carregamento
            {% set filamento_antigo = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}
        {% endif %}

        # Verifica temperatura do bico antes da troca
        {% set temp_atual = printer.extruder.temperature %}
        {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
        {% if temp_atual < temp_minima %}
            M118 Aquecendo bico para troca...
            {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
            M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
            M118 Bico aquecido, iniciando troca...
        {% endif %}

        # CORTAR FILAMENTO ATUAL (só quando precisa trocar)
        M118 Cortando filamento atual...
        CFS_CUT
        M118 Corte concluído

        # PURGAR FILAMENTO RESIDUAL (só quando precisa trocar)
        M118 Executando purga residual...
        CFS_PURGE
        M118 Purga concluída

        # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500

        # Retração do filamento atual
        {% set distancia_retracao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_retracao %}
        G0 E-{distancia_retracao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_retracao|int}
        G4 P500

         # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        {% set distancia_unload = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_unload %}
        CFS_SEND_COMMAND COMMAND="UNLOAD {distancia_unload|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
        G4 P500
        # LOAD: Ir para posição do FILAMENTO NOVO (T1) e carregar
        CFS_SEND_COMMAND COMMAND="T1"
        G4 P1000
        {% set distancia_load = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_load %}
        CFS_SEND_COMMAND COMMAND="LOAD {distancia_load|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}

        # Posicionamento final
        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500
        {% set distancia_extrusao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao %}
        G0 E{distancia_extrusao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_extrusao|int}
        G4 P500
        # RETORNAR PARA POSIÇÃO SALVA ANTES DA TROCA
        {action_respond_info("Retornando para posição anterior: X%.1f Y%.1f Z%.1f" % (pos_x_atual, pos_y_atual, pos_z_atual))}
        G0 X{pos_x_atual} Y{pos_y_atual} Z{pos_z_atual} F6000

        # Atualizar estado persistente
        SET_CURRENT_FILAMENT T=1
        M118 "Filamento T1 carregado - posição restaurada"
    {% endif %}

[gcode_macro T2]
description: Seleciona filamento T2
gcode:
    # Verificar PRIMEIRO se já está na ferramenta desejada (antes de qualquer ação)
    {% set filamento_atual = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}

    # Salvar posição atual do bico para retornar depois (sempre, pois pode ser útil)
    {% set pos_x_atual = printer.toolhead.position.x %}
    {% set pos_y_atual = printer.toolhead.position.y %}
    {% set pos_z_atual = printer.toolhead.position.z %}
    {% if filamento_atual == 2 %}
        M118 Já está selecionado o filamento T2
        # Atualizar estado mesmo assim (por segurança)
        SET_CURRENT_FILAMENT T=2
    {% else %}
        M118 Filamento antigo: T{filamento_atual}, Novo: T2
        # Verificar e carregar estado se necessário
        {% set filamento_antigo = filamento_atual %}
        {% if filamento_antigo == -1 %}
            # Tentar carregar estado salvo se não foi inicializado
            M118 Estado não inicializado - carregando...
            LOAD_CURRENT_FILAMENT
            G4 P1000  # Aguardar carregamento
            {% set filamento_antigo = printer["gcode_macro VARIAVEIS_CHAMELEON"].filamento_atual %}
        {% endif %}

        # Verifica temperatura do bico antes da troca
        {% set temp_atual = printer.extruder.temperature %}
        {% set temp_minima = printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca %}
        {% if temp_atual < temp_minima %}
            M118 Aquecendo bico para troca...
            {action_respond_info("Temperatura atual: %.1f°C, necessária: %.1f°C" % (temp_atual, temp_minima))}
            M109 S{printer["gcode_macro VARIAVEIS_CHAMELEON"].temp_minima_troca|int}  # Aguarda aquecer
            M118 Bico aquecido, iniciando troca...
        {% endif %}

        # CORTAR FILAMENTO ATUAL (só quando precisa trocar)
        M118 Cortando filamento atual...
        CFS_CUT
        M118 Corte concluído

        # PURGAR FILAMENTO RESIDUAL (só quando precisa trocar)
        M118 Executando purga residual...
        CFS_PURGE
        M118 Purga concluída


        # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500

        # Retração do filamento atual
        {% set distancia_retracao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_retracao %}
        G0 E-{distancia_retracao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_retracao|int}
        G4 P500

         # UNLOAD: Ir para posição do FILAMENTO ANTIGO e remover
        {% if filamento_antigo == 0 %}
            CFS_SEND_COMMAND COMMAND="T0"
        {% elif filamento_antigo == 1 %}
            CFS_SEND_COMMAND COMMAND="T1"
        {% elif filamento_antigo == 2 %}
            CFS_SEND_COMMAND COMMAND="T2"
        {% elif filamento_antigo == 3 %}
            CFS_SEND_COMMAND COMMAND="T3"
        {% else %}
            # Se posição desconhecida, assumir T0
            CFS_SEND_COMMAND COMMAND="T0"
        {% endif %}
        G4 P500

        {% set distancia_unload = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_unload %}
        CFS_SEND_COMMAND COMMAND="UNLOAD {distancia_unload|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_unload|int}
        G4 P500
        # LOAD: Ir para posição do FILAMENTO NOVO (T2) e carregar
        CFS_SEND_COMMAND COMMAND="T2"
        G4 P1000
        {% set distancia_load = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_load %}
        CFS_SEND_COMMAND COMMAND="LOAD {distancia_load|int}"
        G4 P{printer["gcode_macro VARIAVEIS_CHAMELEON"].tempo_load|int}
        G4 P500
        # Posicionamento final
        CFS_SEND_COMMAND COMMAND="IDLE"
        G4 P500
        {% set distancia_extrusao = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_extrusao %}
        G0 E{distancia_extrusao} F{printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_extrusao|int}
        G4 P500
        # RETORNAR PARA POSIÇÃO SALVA ANTES DA TROCA
        {action_respond_info("Retornando para posição anterior: X%.1f Y%.1f Z%.1f" % (pos_x_atual, pos_y_atual, pos_z_atual))}
        G0 X{pos_x_atual} Y{pos_y_atual} Z{pos_z_atual} F6000

        # Atualizar estado persistente
        SET_CURRENT_FILAMENT T=2
        M118 "Filamento T2 carregado - posição restaurada"
    {% endif %}

[gcode_macro CFS_HOME]
description: Faz home do seletor
gcode:
    CFS_SEND_COMMAND COMMAND="HOME"

[gcode_macro CFS_IDLE]
description: Move seletor para posição idle
gcode:
    CFS_SEND_COMMAND COMMAND="IDLE"

# [gcode_macro CFS_CUT]
# description: Corta filamento
# gcode:
#     CFS_SEND_COMMAND COMMAND="CUT"

[gcode_macro CFS_CUT]
description: Posiciona hotend para corte físico de filamento (verifica home)
gcode:
    # Verificar se home foi feito (segurança adicional)
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
        M118 Home não detectado - executando HOME completo...
        G28  # Home all (X, Y, Z)
        M118 Home completo concluído

        # APÓS HOME: Aquecer bico para 220°C para corte adequado
        M118 Aquecendo bico para corte (220°C)...
        M109 S220
        M118 Bico aquecido para corte
    {% else %}
        # Verificar temperatura atual e aquecer se necessário
        {% set temp_atual = printer.extruder.temperature %}
        {% if temp_atual < 220 %}
            {action_respond_info("Temperatura atual %.1f°C - aquecendo para corte (220°C)..." % temp_atual)}
            M109 S220
            M118 Bico aquecido para corte
        {% else %}
            {action_respond_info("Temperatura adequada para corte (%.1f°C)" % temp_atual)}
        {% endif %}
    {% endif %}

    # 1. Ir para posição inicial (Y200 X50)
    {% set x1 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_1 %}
    {% set y1 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_1 %}
    G0 X{x1} Y{y1} F6000

    # 2. Ir para segunda posição (Y226 X50)
    {% set x2 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_2 %}
    {% set y2 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_2 %}
    G0 X{x2} Y{y2} F6000

    # 3. Ir para terceira posição (Y226 X6)
    {% set x3 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_3 %}
    {% set y3 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_3 %}
    G0 X{x3} Y{y3} F6000

    # 4. Voltar para quarta posição (Y226 X50)
    {% set x4 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_4 %}
    {% set y4 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_4 %}
    G0 X{x4} Y{y4} F6000

    # 5. Ir para quinta posição (Y226 X6)
    {% set x5 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_5 %}
    {% set y5 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_6 %}
    G0 X{x5} Y{y5} F6000

    # 6. Voltar para sexta posição (Y226 X50)
    {% set x6 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_7 %}
    {% set y6 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_7 %}
    G0 X{x6} Y{y6} F6000

    # 7. Ir para sétima posição (Y226 X6)
    {% set x7 = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_8 %}
    {% set y7 = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_8 %}
    G0 X{x7} Y{y7} F6000

    # 8. Posição final (Y226 X50)
    {% set x_final = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_corte_final %}
    {% set y_final = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_corte_final %}
    G0 X{x_final} Y{y_final} F6000


[gcode_macro CFS_PURGE]
description: Posiciona e purga filamento (verifica home)
gcode:

    # Verificar se home foi feito
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
        M118 Home não detectado - executando HOME completo...
        G28  # Home all (X, Y, Z)
        M118 Home completo concluído
    {% endif %}

    # Obter posições de purga
    {% set x_purga = printer["gcode_macro VARIAVEIS_CHAMELEON"].x_purga %}
    {% set y_purga = printer["gcode_macro VARIAVEIS_CHAMELEON"].y_purga %}
    {% set z_min = printer["gcode_macro VARIAVEIS_CHAMELEON"].z_min_purga %}
    {% set distancia = printer["gcode_macro VARIAVEIS_CHAMELEON"].distancia_purga %}
    {% set velocidade = printer["gcode_macro VARIAVEIS_CHAMELEON"].velocidade_purga %}

    # Verificar posição Z atual
    {% set z_atual = printer.toolhead.position.z %}
    {action_respond_info("Z atual: %.1f, Z mínimo para purga: %.1f" % (z_atual, z_min))}

    # Ajustar Z se necessário
    {% if z_atual < z_min %}
        M118 Movendo Z para posição segura de purga
        G0 Z{z_min} F600
    {% else %}
        M118 Z já está em posição segura
    {% endif %}

    # Mover para posição de purga
    G0 X{x_purga} Y{y_purga} F6000

[gcode_macro CFS_STATUS]
description: Mostra status do Arduino
gcode:
    CFS_SEND_COMMAND COMMAND="STATUS"

[gcode_macro CFS_TEST_LOAD]
description: Testa LOAD/UNLOAD automático (não execute em produção)
gcode:
    M117 "Teste LOAD/UNLOAD automático..."
    CFS_SEND_COMMAND COMMAND="T0"
    G4 P1000
    CFS_SEND_COMMAND COMMAND="LOAD 20"
    G4 P2000
    CFS_SEND_COMMAND COMMAND="UNLOAD 20"
    G4 P1000
    CFS_SEND_COMMAND COMMAND="IDLE"
    M117 "Teste concluído"


#Execulta as macros na inicicialização
[delayed_gcode inicializar_estado_chameleon]
initial_duration: 2.0
gcode:
    # Chama a macro que lê do arquivo e joga para a memória RAM
    LOAD_CURRENT_FILAMENT
    {action_respond_info("Chameleon: Estado inicial carregado do arquivo.")}


# =============================================================================
# CONFIGURAÇÃO PARA USO - SISTEMA AUTOMÁTICO
# =============================================================================

# ✅ SISTEMA COMPLETAMENTE AUTOMÁTICO - configurado corretamente!

# O que foi configurado:
# 1. [gcode_shell_command arduino_control] - executa comandos Python automaticamente
# 2. CFS_SEND_COMMAND - macro que usa RUN_SHELL_COMMAND para executar comandos
# 3. T0-T3 - macros completas de troca de filamento COM ESTADO PERSISTENTE
# 4. [delayed_gcode CFS_STARTUP] - carregamento automático 2s após inicialização
# 5. Baseado na documentação: https://github.com/dw-0/kiauh/blob/master/docs/gcode_shell_command.md

# SISTEMA AUTOMÁTICO FUNCIONANDO ✅
#
# CARREGAMENTO AUTOMÁTICO:
# - Estado é carregado automaticamente 2 segundos após FIRMWARE_RESTART
# - Não precisa executar comandos manuais após reinicialização
#
# Como usar:
# - CFS_CURRENT_FILAMENT           # Ver filamento atual (com ícones)
# - LOAD_CURRENT_FILAMENT          # Carrega estado do arquivo para RAM
# - CURRENT_FILAMENT                # Mostra filamento atual da RAM
# - SET_CURRENT_FILAMENT T=X        # Define filamento atual (salva em arquivo e RAM)
# - T0, T1, T2: Trocas completas (usam CURRENT_FILAMENT e salvam com SET_CURRENT_FILAMENT)
# - CFS_HOME, CFS_IDLE, CFS_CUT, CFS_STATUS: Comandos diretos
# - CFS_CUT: Posiciona hotend para corte físico de filamento
# - CFS_PURGE: Posiciona e purga filamento automaticamente
# - CFS_STATUS_FULL: Status completo (filamento + temperatura + Arduino)
# - CFS_GET_CURRENT_FILAMENT: Ver filamento atual salvo
# - CFS_RESET_STATE: Reset estado persistente (cuidado!)
# - CFS_TEST_LOAD: Testa sistema completo
#
# PERSISTÊNCIA:
# - Estado salvo em: /usr/data/printer_data/config/chameleon_state.json
# - Script Python com comandos GET_FILAMENT e SET_FILAMENT
# - Carregamento MANUAL via CFS_LOAD_STATE
# - Sobrevive a reinicializações e crashes
#
# CORTE DE FILAMENTO:
# - Sequência segura: Y200 X50 → Y227 X50 → Y227 X13 → Y227 X50
# - Verificação automática de HOME completo (X,Y,Z) antes de cortar
# - CFS_CUT: Posiciona hotend fisicamente para corte
# - CFS_PURGE: Posiciona e purga filamento automaticamente
#
# O shell_command executa automaticamente:
# python3 /usr/data/printer_data/config/control_arduino.py [comando]
#
# Para depuração:
# - Verifique logs do Klipper em caso de erro
# - Use CFS_TEST para validar funcionamento
# - CFS_CURRENT_FILAMENT mostra status visual

# Exemplo de uso em slicer (PrusaSlicer/Custom G-code):
# Tool change G-code:
# CFS_T{next_extruder}
# M117 "Filamento {next_extruder} carregado"

# Exemplo de uso manual:
# LOAD_CURRENT_FILAMENT          ; Carrega estado salvo do arquivo
# CURRENT_FILAMENT               ; Mostra filamento atual
# SET_CURRENT_FILAMENT T=1       ; Define filamento atual
# T1                            ; Troca completa para T1 (usa sistema automático)
# CFS_PURGE                      ; Purga filamento novo
# CFS_CUT                        ; Posiciona hotend para corte físico
# CFS_STATUS_FULL                ; Verifica status completo
# CFS_HOME                       ; Home do seletor
